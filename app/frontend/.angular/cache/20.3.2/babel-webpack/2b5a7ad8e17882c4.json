{"ast":null,"code":"import _asyncToGenerator from \"C:/manga/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { computed, signal } from '@angular/core';\nimport * as i0 from \"@angular/core\";\nexport let ApiService = /*#__PURE__*/(() => {\n  var _staticBlock;\n  class ApiService {\n    constructor() {\n      this.base = localStorage.getItem('apiBase') || 'http://localhost:3000';\n      this.token = signal(localStorage.getItem('token'), ...(ngDevMode ? [{\n        debugName: \"token\"\n      }] : []));\n      this.role = computed(() => {\n        const t = this.token();\n        if (!t) return 'none';\n        try {\n          const payload = JSON.parse(atob(t.split('.')[1]));\n          return payload.role ?? 'none';\n        } catch {\n          return 'none';\n        }\n      }, ...(ngDevMode ? [{\n        debugName: \"role\"\n      }] : []));\n      this.email = computed(() => {\n        const t = this.token();\n        if (!t) return null;\n        try {\n          return JSON.parse(atob(t.split('.')[1]))?.email ?? null;\n        } catch {\n          return null;\n        }\n      }, ...(ngDevMode ? [{\n        debugName: \"email\"\n      }] : []));\n    }\n    authHeaders(extra = {}) {\n      const headers = {\n        ...extra\n      };\n      const t = this.token();\n      if (t) headers['Authorization'] = `Bearer ${t}`;\n      return headers;\n    }\n    jsonHeaders() {\n      return this.authHeaders({\n        'Content-Type': 'application/json'\n      });\n    }\n    login(email, password) {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        const payload = {\n          email: email.trim().toLowerCase(),\n          password\n        };\n        const r = yield fetch(`${_this.base}/api/auth/login`, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify(payload)\n        });\n        if (!r.ok) throw new Error('Login failed');\n        const data = yield r.json();\n        localStorage.setItem('token', data.accessToken);\n        _this.token.set(data.accessToken);\n      })();\n    }\n    logout() {\n      localStorage.removeItem('token');\n      this.token.set(null);\n    }\n    me() {\n      var _this2 = this;\n      return _asyncToGenerator(function* () {\n        if (!_this2.token()) return null;\n        const r = yield fetch(`${_this2.base}/api/auth/me`, {\n          headers: _this2.authHeaders()\n        });\n        if (!r.ok) return null;\n        const data = yield r.json();\n        return data.user;\n      })();\n    }\n    listBooks(params) {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        const q = new URLSearchParams();\n        if (params?.query) q.set('query', params.query);\n        if (params?.format) q.set('format', params.format);\n        if (params?.tag) q.set('tag', params.tag);\n        if (params?.lang) q.set('lang', params.lang);\n        if (params?.sort) q.set('sort', params.sort);\n        if (params?.page) q.set('page', String(params.page));\n        if (params?.limit) q.set('limit', String(params.limit));\n        const url = `${_this3.base}/api/books${q.toString() ? `?${q.toString()}` : ''}`;\n        const r = yield fetch(url, {\n          headers: _this3.authHeaders()\n        });\n        if (!r.ok) throw new Error('Failed to load books');\n        return r.json();\n      })();\n    }\n    getBook(id) {\n      var _this4 = this;\n      return _asyncToGenerator(function* () {\n        const r = yield fetch(`${_this4.base}/api/books/${id}`, {\n          headers: _this4.authHeaders()\n        });\n        if (!r.ok) throw new Error('Not found');\n        return r.json();\n      })();\n    }\n    getTags() {\n      var _this5 = this;\n      return _asyncToGenerator(function* () {\n        const r = yield fetch(`${_this5.base}/api/tags`, {\n          headers: _this5.authHeaders()\n        });\n        if (!r.ok) throw new Error('Failed to load tags');\n        const data = yield r.json();\n        return data.tags?.map(t => t.name) ?? [];\n      })();\n    }\n    getLanguages() {\n      var _this6 = this;\n      return _asyncToGenerator(function* () {\n        const r = yield fetch(`${_this6.base}/api/books/languages`, {\n          headers: _this6.authHeaders()\n        });\n        if (!r.ok) throw new Error('Failed to load languages');\n        const data = yield r.json();\n        return data.languages ?? [];\n      })();\n    }\n    uploadBook(form) {\n      var _this7 = this;\n      return _asyncToGenerator(function* () {\n        const r = yield fetch(`${_this7.base}/api/books/upload`, {\n          method: 'POST',\n          headers: _this7.authHeaders(),\n          body: form\n        });\n        if (!r.ok) throw new Error('Upload failed');\n        return r.json();\n      })();\n    }\n    deleteBook(id) {\n      var _this8 = this;\n      return _asyncToGenerator(function* () {\n        const r = yield fetch(`${_this8.base}/api/books/${id}`, {\n          method: 'DELETE',\n          headers: _this8.authHeaders()\n        });\n        if (!r.ok) throw new Error('Delete failed');\n      })();\n    }\n    getProgress(id) {\n      var _this9 = this;\n      return _asyncToGenerator(function* () {\n        const r = yield fetch(`${_this9.base}/api/books/${id}/progress`, {\n          headers: _this9.authHeaders()\n        });\n        if (!r.ok) return null;\n        const data = yield r.json();\n        return data.progress ? {\n          page: data.progress.page ?? 0,\n          percent: data.progress.percent ?? 0\n        } : null;\n      })();\n    }\n    setProgress(id, page, percent) {\n      var _this0 = this;\n      return _asyncToGenerator(function* () {\n        yield fetch(`${_this0.base}/api/books/${id}/progress`, {\n          method: 'POST',\n          headers: _this0.jsonHeaders(),\n          body: JSON.stringify({\n            page,\n            percent\n          })\n        });\n      })();\n    }\n    adminListUsers() {\n      var _this1 = this;\n      return _asyncToGenerator(function* () {\n        const r = yield fetch(`${_this1.base}/api/users`, {\n          headers: _this1.authHeaders()\n        });\n        if (!r.ok) throw new Error('Not authorized');\n        return (yield r.json()).users;\n      })();\n    }\n    adminCreateUser(email, password, role) {\n      var _this10 = this;\n      return _asyncToGenerator(function* () {\n        const r = yield fetch(`${_this10.base}/api/users`, {\n          method: 'POST',\n          headers: _this10.jsonHeaders(),\n          body: JSON.stringify({\n            email,\n            password,\n            role\n          })\n        });\n        if (!r.ok) throw new Error('Create failed');\n        return (yield r.json()).user;\n      })();\n    }\n    adminSetPassword(id, password) {\n      var _this11 = this;\n      return _asyncToGenerator(function* () {\n        const r = yield fetch(`${_this11.base}/api/users/${id}`, {\n          method: 'PATCH',\n          headers: _this11.jsonHeaders(),\n          body: JSON.stringify({\n            password\n          })\n        });\n        if (!r.ok) throw new Error('Update failed');\n      })();\n    }\n    adminListAudit() {\n      var _this12 = this;\n      return _asyncToGenerator(function* (limit = 200) {\n        const r = yield fetch(`${_this12.base}/api/audit?limit=${limit}`, {\n          headers: _this12.authHeaders()\n        });\n        if (!r.ok) throw new Error('Not authorized');\n        return (yield r.json()).events;\n      }).apply(this, arguments);\n    }\n    changePassword(currentPassword, newPassword) {\n      var _this13 = this;\n      return _asyncToGenerator(function* () {\n        const r = yield fetch(`${_this13.base}/api/account/password`, {\n          method: 'PATCH',\n          headers: _this13.jsonHeaders(),\n          body: JSON.stringify({\n            currentPassword,\n            newPassword\n          })\n        });\n        if (!r.ok) throw new Error('Password change failed');\n      })();\n    }\n    static #_ = _staticBlock = () => (this.ɵfac = function ApiService_Factory(__ngFactoryType__) {\n      return new (__ngFactoryType__ || ApiService)();\n    }, this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: ApiService,\n      factory: ApiService.ɵfac,\n      providedIn: 'root'\n    }));\n  }\n  _staticBlock();\n  return ApiService;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}