{"ast":null,"code":"import _asyncToGenerator from \"C:/manga/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../services/api.service\";\nimport * as i2 from \"../services/burst.service\";\nimport * as i3 from \"../services/toast.service\";\nimport * as i4 from \"@angular/common\";\nimport * as i5 from \"@angular/forms\";\nfunction UploadPage_p_29_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\", 19);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\"Ausgewaehlt: \", ctx_r0.file == null ? null : ctx_r0.file.name);\n  }\n}\nfunction UploadPage_div_32_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 20)(1, \"div\", 21);\n    i0.ɵɵelement(2, \"div\", 22);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"div\", 23);\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵstyleProp(\"width\", ctx_r0.progress, \"%\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\"\", ctx_r0.progress, \" %\");\n  }\n}\nexport let UploadPage = /*#__PURE__*/(() => {\n  var _staticBlock;\n  class UploadPage {\n    constructor(api, bursts, toast) {\n      this.api = api;\n      this.bursts = bursts;\n      this.toast = toast;\n      this.title = '';\n      this.author = '';\n      this.language = '';\n      this.tags = '';\n      this.busy = false;\n      this.progress = 0;\n      this.dragActive = false;\n    }\n    onFile(event) {\n      const files = event.target.files;\n      this.file = files && files.length ? files[0] : undefined;\n    }\n    onDragOver(event) {\n      event.preventDefault();\n      this.dragActive = true;\n    }\n    onDragLeave(event) {\n      event.preventDefault();\n      this.dragActive = false;\n    }\n    onDrop(event) {\n      event.preventDefault();\n      this.dragActive = false;\n      if (event.dataTransfer?.files?.length) {\n        this.file = event.dataTransfer.files[0];\n      }\n    }\n    submit() {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        if (!_this.file) {\n          _this.toast.show('Bitte eine Datei auswaehlen.', 'error');\n          return;\n        }\n        const form = new FormData();\n        form.set('title', _this.title.trim());\n        form.set('author', _this.author.trim());\n        form.set('language', _this.language.trim());\n        form.set('tags', _this.tags);\n        form.set('file', _this.file);\n        _this.busy = true;\n        _this.progress = 0;\n        try {\n          _this.bursts.trigger(16);\n          yield _this.uploadWithProgress(form);\n          _this.bursts.trigger(24);\n          _this.toast.show('Upload erfolgreich abgeschlossen', 'success');\n          _this.resetForm();\n        } catch (err) {\n          console.error(err);\n          _this.toast.show('Fehler beim Upload', 'error');\n        } finally {\n          _this.busy = false;\n        }\n      })();\n    }\n    resetForm() {\n      this.title = '';\n      this.author = '';\n      this.language = '';\n      this.tags = '';\n      this.file = undefined;\n      this.progress = 0;\n    }\n    uploadWithProgress(form) {\n      return new Promise((resolve, reject) => {\n        const xhr = new XMLHttpRequest();\n        xhr.open('POST', `${this.api.base}/api/books/upload`);\n        const token = this.api.token();\n        if (token) xhr.setRequestHeader('Authorization', `Bearer ${token}`);\n        xhr.upload.onprogress = event => {\n          if (event.lengthComputable) {\n            this.progress = Math.min(100, Math.round(event.loaded / event.total * 100));\n          }\n        };\n        xhr.onerror = () => reject(new Error('Upload fehlgeschlagen'));\n        xhr.onload = () => {\n          if (xhr.status >= 200 && xhr.status < 300) {\n            resolve();\n          } else {\n            reject(new Error(xhr.statusText));\n          }\n        };\n        xhr.send(form);\n      });\n    }\n    static #_ = _staticBlock = () => (this.ɵfac = function UploadPage_Factory(__ngFactoryType__) {\n      return new (__ngFactoryType__ || UploadPage)(i0.ɵɵdirectiveInject(i1.ApiService), i0.ɵɵdirectiveInject(i2.BurstService), i0.ɵɵdirectiveInject(i3.ToastService));\n    }, this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n      type: UploadPage,\n      selectors: [[\"app-upload\"]],\n      decls: 33,\n      vars: 12,\n      consts: [[1, \"max-w-xl\", \"mx-auto\", \"card\", \"space-y-4\"], [1, \"text-lg\", \"font-bold\"], [1, \"text-sm\", \"text-gray-600\"], [1, \"space-y-3\", 3, \"ngSubmit\"], [1, \"grid\", \"gap-2\"], [\"for\", \"title\", 1, \"text-sm\", \"font-medium\"], [\"id\", \"title\", \"type\", \"text\", \"placeholder\", \"Titel\", \"name\", \"title\", \"required\", \"\", 1, \"w-full\", \"border\", \"p-2\", \"rounded\", 3, \"ngModelChange\", \"ngModel\"], [\"for\", \"author\", 1, \"text-sm\", \"font-medium\"], [\"id\", \"author\", \"type\", \"text\", \"placeholder\", \"Autor\", \"name\", \"author\", 1, \"w-full\", \"border\", \"p-2\", \"rounded\", 3, \"ngModelChange\", \"ngModel\"], [\"for\", \"language\", 1, \"text-sm\", \"font-medium\"], [\"id\", \"language\", \"type\", \"text\", \"placeholder\", \"z. B. de, en, ja\", \"name\", \"language\", 1, \"w-full\", \"border\", \"p-2\", \"rounded\", 3, \"ngModelChange\", \"ngModel\"], [\"for\", \"tags\", 1, \"text-sm\", \"font-medium\"], [\"id\", \"tags\", \"type\", \"text\", \"placeholder\", \"Action, Romance\", \"name\", \"tags\", 1, \"w-full\", \"border\", \"p-2\", \"rounded\", 3, \"ngModelChange\", \"ngModel\"], [1, \"border-2\", \"border-dashed\", \"rounded-lg\", \"p-6\", \"text-center\", \"transition\", 3, \"dragover\", \"dragleave\", \"drop\"], [1, \"mb-2\"], [\"type\", \"file\", 1, \"w-full\", 3, \"change\"], [\"class\", \"mt-2 text-sm text-gray-600\", 4, \"ngIf\"], [1, \"bg-matcha\", \"text-white\", \"px-4\", \"py-2\", \"rounded\", \"w-full\", 3, \"disabled\"], [\"class\", \"space-y-2\", 4, \"ngIf\"], [1, \"mt-2\", \"text-sm\", \"text-gray-600\"], [1, \"space-y-2\"], [1, \"h-2\", \"bg-gray-200\", \"rounded\"], [1, \"h-2\", \"bg-kurenai\", \"rounded\"], [1, \"text-xs\", \"text-gray-500\", \"text-center\"]],\n      template: function UploadPage_Template(rf, ctx) {\n        if (rf & 1) {\n          i0.ɵɵelementStart(0, \"section\", 0)(1, \"h1\", 1);\n          i0.ɵɵtext(2, \"Upload\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(3, \"p\", 2);\n          i0.ɵɵtext(4, \" Unterstuetzte Formate: PDF, EPUB, CBZ/ZIP oder ZIP mit Bilder-Ordnern. Die Dateien landen in \");\n          i0.ɵɵelementStart(5, \"code\");\n          i0.ɵɵtext(6, \"storage/originals\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵtext(7, \". \");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(8, \"form\", 3);\n          i0.ɵɵlistener(\"ngSubmit\", function UploadPage_Template_form_ngSubmit_8_listener() {\n            return ctx.submit();\n          });\n          i0.ɵɵelementStart(9, \"div\", 4)(10, \"label\", 5);\n          i0.ɵɵtext(11, \"Titel *\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(12, \"input\", 6);\n          i0.ɵɵtwoWayListener(\"ngModelChange\", function UploadPage_Template_input_ngModelChange_12_listener($event) {\n            i0.ɵɵtwoWayBindingSet(ctx.title, $event) || (ctx.title = $event);\n            return $event;\n          });\n          i0.ɵɵelementEnd()();\n          i0.ɵɵelementStart(13, \"div\", 4)(14, \"label\", 7);\n          i0.ɵɵtext(15, \"Autor / Zeichner\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(16, \"input\", 8);\n          i0.ɵɵtwoWayListener(\"ngModelChange\", function UploadPage_Template_input_ngModelChange_16_listener($event) {\n            i0.ɵɵtwoWayBindingSet(ctx.author, $event) || (ctx.author = $event);\n            return $event;\n          });\n          i0.ɵɵelementEnd()();\n          i0.ɵɵelementStart(17, \"div\", 4)(18, \"label\", 9);\n          i0.ɵɵtext(19, \"Sprache\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(20, \"input\", 10);\n          i0.ɵɵtwoWayListener(\"ngModelChange\", function UploadPage_Template_input_ngModelChange_20_listener($event) {\n            i0.ɵɵtwoWayBindingSet(ctx.language, $event) || (ctx.language = $event);\n            return $event;\n          });\n          i0.ɵɵelementEnd()();\n          i0.ɵɵelementStart(21, \"div\", 4)(22, \"label\", 11);\n          i0.ɵɵtext(23, \"Tags (Komma-getrennt)\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(24, \"input\", 12);\n          i0.ɵɵtwoWayListener(\"ngModelChange\", function UploadPage_Template_input_ngModelChange_24_listener($event) {\n            i0.ɵɵtwoWayBindingSet(ctx.tags, $event) || (ctx.tags = $event);\n            return $event;\n          });\n          i0.ɵɵelementEnd()();\n          i0.ɵɵelementStart(25, \"div\", 13);\n          i0.ɵɵlistener(\"dragover\", function UploadPage_Template_div_dragover_25_listener($event) {\n            return ctx.onDragOver($event);\n          })(\"dragleave\", function UploadPage_Template_div_dragleave_25_listener($event) {\n            return ctx.onDragLeave($event);\n          })(\"drop\", function UploadPage_Template_div_drop_25_listener($event) {\n            return ctx.onDrop($event);\n          });\n          i0.ɵɵelementStart(26, \"p\", 14);\n          i0.ɵɵtext(27, \"Datei hier ablegen oder auswaehlen\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(28, \"input\", 15);\n          i0.ɵɵlistener(\"change\", function UploadPage_Template_input_change_28_listener($event) {\n            return ctx.onFile($event);\n          });\n          i0.ɵɵelementEnd();\n          i0.ɵɵtemplate(29, UploadPage_p_29_Template, 2, 1, \"p\", 16);\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(30, \"button\", 17);\n          i0.ɵɵtext(31);\n          i0.ɵɵelementEnd()();\n          i0.ɵɵtemplate(32, UploadPage_div_32_Template, 5, 3, \"div\", 18);\n          i0.ɵɵelementEnd();\n        }\n        if (rf & 2) {\n          i0.ɵɵadvance(12);\n          i0.ɵɵtwoWayProperty(\"ngModel\", ctx.title);\n          i0.ɵɵadvance(4);\n          i0.ɵɵtwoWayProperty(\"ngModel\", ctx.author);\n          i0.ɵɵadvance(4);\n          i0.ɵɵtwoWayProperty(\"ngModel\", ctx.language);\n          i0.ɵɵadvance(4);\n          i0.ɵɵtwoWayProperty(\"ngModel\", ctx.tags);\n          i0.ɵɵadvance();\n          i0.ɵɵclassProp(\"border-kurenai\", ctx.dragActive)(\"bg-sakura\", ctx.dragActive);\n          i0.ɵɵadvance(4);\n          i0.ɵɵproperty(\"ngIf\", ctx.file);\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"disabled\", ctx.busy);\n          i0.ɵɵadvance();\n          i0.ɵɵtextInterpolate1(\" \", ctx.busy ? \"Upload laeuft...\" : \"Hochladen\", \" \");\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"ngIf\", ctx.busy);\n        }\n      },\n      dependencies: [CommonModule, i4.NgIf, FormsModule, i5.ɵNgNoValidate, i5.DefaultValueAccessor, i5.NgControlStatus, i5.NgControlStatusGroup, i5.RequiredValidator, i5.NgModel, i5.NgForm],\n      encapsulation: 2\n    }));\n  }\n  _staticBlock();\n  return UploadPage;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}